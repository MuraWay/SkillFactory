Задание 4.1

База данных содержит список аэропортов практически всех крупных городов России. В большинстве городов есть только один аэропорт. Исключение составляет:
Moscow, Ulyanovsk

SELECT a.city,
       count(*)
FROM dst_project.AIRPORTS a
GROUP BY a.city
ORDER BY 2 DESC
-- Ответ: Moscow, Ulyanovsk


Задание 4.2

Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах. 
Сколько всего статусов для рейсов определено в таблице?

SELECT count(DISTINCT f.status)
FROM dst_project.FLIGHTS f
-- Ответ: 6
 
 
Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе (статус рейса «самолёт уже вылетел и находится в воздухе»).

-- Вариант 1 - по статусу
SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.status = 'Departed'
-- Ответ: 58
 
-- Вариант 2 - есть фактическое время вылета и нет факт. времени прилёта
SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.actual_departure IS NOT NULL
  AND f.actual_arrival IS NULL
-- Ответ: 58


Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели 773 (Boeing 777-300)?

SELECT a.model,
       count(s.seat_no)
FROM dst_project.AIRCRAFTS a
JOIN dst_project.SEATS s ON a.aircraft_code=s.aircraft_code
WHERE a.model = 'Boeing 777-300'
GROUP BY 1
-- Ответ: 402


Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года?
Здесь и далее состоявшийся рейс означает, что он не отменён, и самолёт прибыл в пункт назначения.

SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.actual_arrival BETWEEN '2017/04/01' AND '2017/09/01'
  AND f.status = 'Arrived'
-- Ответ: 74227


Задание 4.3

Вопрос 1. Сколько всего рейсов было отменено по данным базы?

SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.status = 'Cancelled'
-- 437


 
Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок?

SELECT CASE
           WHEN a.model like 'Sukhoi Superjet%' THEN split_part(a.model, '-', 1)
           ELSE split_part(a.model, ' ', 1)
       END ,
       count(a.aircraft_code)
FROM dst_project.AIRCRAFTS a
WHERE a.model SIMILAR TO '(Boeing|Sukhoi Superjet|Airbus)%'
GROUP BY 1

Boeing: 3
 
Sukhoi Superjet: 1
 
Airbus: 3
 


Вопрос 3. В какой части (частях) света находится больше аэропортов?

SELECT split_part(a.timezone, '/', 1),
       count(a.airport_code)
FROM dst_project.AIRPORTS a
GROUP BY 1

--Europe, Asia

Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id).

SELECT f.flight_id
FROM
  (SELECT a.flight_id,
          a.actual_arrival - a.scheduled_arrival
   FROM dst_project.FLIGHTS a
   ORDER BY 2 DESC NULLS LAST
   LIMIT 1) f
--157571


Задание 4.4

Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных?

SELECT min(f.scheduled_departure)
FROM dst_project.FLIGHTS f
--14.08.2016

Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?

SELECT EXTRACT(EPOCH
               FROM f.duration::INTERVAL)/60
FROM
  (SELECT a.scheduled_arrival - a.scheduled_departure duration
   FROM dst_project.FLIGHTS a
   ORDER BY 1 DESC
   LIMIT 1) f
--530
 
Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс?

SELECT f.departure_airport,
       f.arrival_airport
FROM
  (SELECT a.departure_airport,
          a.arrival_airport,
          a.scheduled_arrival - a.scheduled_departure duration
   FROM dst_project.FLIGHTS a
   ORDER BY 3 DESC NULLS LAST
   LIMIT 1) f
--DME - UUS


Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут).

WITH a AS
  (SELECT date_trunc('minute', avg(a.actual_arrival - a.actual_departure)) avg_duration
   FROM dst_project.FLIGHTS a)
SELECT EXTRACT(EPOCH
               FROM a.avg_duration::INTERVAL)/60
FROM a
--128

 
Задание 4.5

Вопрос 1. Мест какого класса у SU9 больше всего?

SELECT f.fare_conditions
FROM
  (SELECT s.fare_conditions,
          count(s.seat_no) qty
   FROM dst_project.SEATS s
   WHERE s.aircraft_code = 'SU9'
   GROUP BY 1
   ORDER BY 2 DESC
   LIMIT 1) f
   
-- Economy


Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю?

SELECT min(b.total_amount)
FROM dst_project.BOOKINGS b

-- 3400

 
Вопрос 3. Какой номер места был у пассажира с id = 4313 788533?

SELECT b.seat_no
FROM dst_project.tickets t
JOIN dst_project.boarding_passes b ON t.ticket_no = b.ticket_no
WHERE t.passenger_id = '4313 788533'
-- 2A


Задание 5.1

Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?

SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
JOIN dst_project.AIRPORTS a ON f.arrival_airport = a.airport_code
WHERE f.status = 'Arrived'
  AND a.city = 'Anapa'
  AND date_part('year', f.actual_arrival) = '2017'

-- 486

 
Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?

SELECT count(*)
FROM dst_project.FLIGHTS f
JOIN dst_project.AIRPORTS a ON f.departure_airport = a.airport_code
WHERE a.city = 'Anapa'
  AND date_part('year', f.actual_departure) = 2017
  AND date_part('month', f.actual_departure) in (12,1,2)


-- или если обращаться сразу по коду аэропорта Анапы

SELECT count(*)
FROM dst_project.FLIGHTS f
WHERE f.departure_airport = 'AAQ'
  AND date_part('year', f.actual_departure) = 2017
  AND date_part('month', f.actual_departure) in (12,1,2)
  -- 127
 
Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время.

SELECT count(*)
FROM dst_project.FLIGHTS f
WHERE f.departure_airport = 'AAQ'
  AND f.status = 'Cancelled'
  --1
 
Вопрос 4. Сколько рейсов из Анапы не летают в Москву?

SELECT count(*)
FROM dst_project.FLIGHTS f
JOIN dst_project.AIRPORTS a ON f.arrival_airport = a.airport_code
WHERE f.departure_airport = 'AAQ'
  AND a.city != 'Moscow'
  -- 453
 
Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?

SELECT f.model
FROM
  (SELECT a.model,
          count(DISTINCT s.seat_no)
   FROM dst_project.FLIGHTS f
   JOIN dst_project.SEATS s ON f.aircraft_code = s.aircraft_code
   JOIN dst_project.AIRCRAFTS a ON f.aircraft_code = a.aircraft_code
   WHERE f.departure_airport = 'AAQ'
   GROUP BY a.model
   ORDER BY 2 DESC
   LIMIT 1) f
    -- Boeing 737-300 