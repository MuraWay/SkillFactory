Задание 4.1

База данных содержит список аэропортов практически всех крупных городов России. В большинстве городов есть только один аэропорт. Исключение составляет:
Moscow, Ulyanovsk

SELECT a.city,
       count(*)
FROM dst_project.AIRPORTS a
GROUP BY a.city
ORDER BY 2 DESC
-- Ответ: Moscow, Ulyanovsk


Задание 4.2

Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах. 
Сколько всего статусов для рейсов определено в таблице?

SELECT count(DISTINCT f.status)
FROM dst_project.FLIGHTS f
-- Ответ: 6
 
 
Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе (статус рейса «самолёт уже вылетел и находится в воздухе»).

-- Вариант 1 - по статусу
SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.status = 'Departed'
-- Ответ: 58
 
-- Вариант 2 - есть фактическое время вылета и нет факт. времени прилёта
SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.actual_departure IS NOT NULL
  AND f.actual_arrival IS NULL
-- Ответ: 58


Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели 773 (Boeing 777-300)?

SELECT a.model,
       count(s.seat_no)
FROM dst_project.AIRCRAFTS a
JOIN dst_project.SEATS s ON a.aircraft_code=s.aircraft_code
WHERE a.model = 'Boeing 777-300'
GROUP BY 1
-- Ответ: 402


Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года?
Здесь и далее состоявшийся рейс означает, что он не отменён, и самолёт прибыл в пункт назначения.

SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.actual_arrival BETWEEN '2017/04/01' AND '2017/09/01'
  AND f.status = 'Arrived'
-- Ответ: 74227


Задание 4.3

Вопрос 1. Сколько всего рейсов было отменено по данным базы?

SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
WHERE f.status = 'Cancelled'
-- 437


 
Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок?

SELECT CASE
           WHEN a.model like 'Sukhoi Superjet%' THEN split_part(a.model, '-', 1)
           ELSE split_part(a.model, ' ', 1)
       END ,
       count(a.aircraft_code)
FROM dst_project.AIRCRAFTS a
WHERE a.model SIMILAR TO '(Boeing|Sukhoi Superjet|Airbus)%'
GROUP BY 1

Boeing: 3
 
Sukhoi Superjet: 1
 
Airbus: 3
 


Вопрос 3. В какой части (частях) света находится больше аэропортов?

SELECT split_part(a.timezone, '/', 1),
       count(a.airport_code)
FROM dst_project.AIRPORTS a
GROUP BY 1

--Europe, Asia

Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id).

SELECT f.flight_id
FROM
  (SELECT a.flight_id,
          a.actual_arrival - a.scheduled_arrival
   FROM dst_project.FLIGHTS a
   ORDER BY 2 DESC NULLS LAST
   LIMIT 1) f
--157571


Задание 4.4

Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных?

SELECT min(f.scheduled_departure)
FROM dst_project.FLIGHTS f
--14.08.2016

Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?

SELECT EXTRACT(EPOCH
               FROM f.duration::INTERVAL)/60
FROM
  (SELECT a.scheduled_arrival - a.scheduled_departure duration
   FROM dst_project.FLIGHTS a
   ORDER BY 1 DESC
   LIMIT 1) f
--530
 
Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс?

SELECT f.departure_airport,
       f.arrival_airport
FROM
  (SELECT a.departure_airport,
          a.arrival_airport,
          a.scheduled_arrival - a.scheduled_departure duration
   FROM dst_project.FLIGHTS a
   ORDER BY 3 DESC NULLS LAST
   LIMIT 1) f
--DME - UUS


Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут).

WITH a AS
  (SELECT date_trunc('minute', avg(a.actual_arrival - a.actual_departure)) avg_duration
   FROM dst_project.FLIGHTS a)
SELECT EXTRACT(EPOCH
               FROM a.avg_duration::INTERVAL)/60
FROM a
--128

 
Задание 4.5

Вопрос 1. Мест какого класса у SU9 больше всего?

SELECT f.fare_conditions
FROM
  (SELECT s.fare_conditions,
          count(s.seat_no) qty
   FROM dst_project.SEATS s
   WHERE s.aircraft_code = 'SU9'
   GROUP BY 1
   ORDER BY 2 DESC
   LIMIT 1) f
   
-- Economy


Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю?

SELECT min(b.total_amount)
FROM dst_project.BOOKINGS b

-- 3400

 
Вопрос 3. Какой номер места был у пассажира с id = 4313 788533?

SELECT b.seat_no
FROM dst_project.tickets t
JOIN dst_project.boarding_passes b ON t.ticket_no = b.ticket_no
WHERE t.passenger_id = '4313 788533'
-- 2A


Задание 5.1

Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?

SELECT count(f.flight_id)
FROM dst_project.FLIGHTS f
JOIN dst_project.AIRPORTS a ON f.arrival_airport = a.airport_code
WHERE f.status = 'Arrived'
  AND a.city = 'Anapa'
  AND date_part('year', f.actual_arrival) = '2017'

-- 486

 
Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?

SELECT count(*)
FROM dst_project.FLIGHTS f
JOIN dst_project.AIRPORTS a ON f.departure_airport = a.airport_code
WHERE a.city = 'Anapa'
  AND date_part('year', f.actual_departure) = 2017
  AND date_part('month', f.actual_departure) in (12,1,2)


-- или если обращаться сразу по коду аэропорта Анапы

SELECT count(*)
FROM dst_project.FLIGHTS f
WHERE f.departure_airport = 'AAQ'
  AND date_part('year', f.actual_departure) = 2017
  AND date_part('month', f.actual_departure) in (12,1,2)
  -- 127
 
Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время.

SELECT count(*)
FROM dst_project.FLIGHTS f
WHERE f.departure_airport = 'AAQ'
  AND f.status = 'Cancelled'
  --1
 
Вопрос 4. Сколько рейсов из Анапы не летают в Москву?

SELECT count(*)
FROM dst_project.FLIGHTS f
JOIN dst_project.AIRPORTS a ON f.arrival_airport = a.airport_code
WHERE f.departure_airport = 'AAQ'
  AND a.city != 'Moscow'
  -- 453
 
Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?

SELECT f.model
FROM
  (SELECT a.model,
          count(DISTINCT s.seat_no)
   FROM dst_project.FLIGHTS f
   JOIN dst_project.SEATS s ON f.aircraft_code = s.aircraft_code
   JOIN dst_project.AIRCRAFTS a ON f.aircraft_code = a.aircraft_code
   WHERE f.departure_airport = 'AAQ'
   GROUP BY a.model
   ORDER BY 2 DESC
   LIMIT 1) f
    -- Boeing 737-300 


Итоговый датасет

WITH table_1 AS -- Перелёты + посадочные таллоны
    (
      SELECT 
          tf.flight_id,
          count(DISTINCT tf.fare_conditions) total_classes, -- сколько классов обслуживания на рейсе
          count(CASE -- Количество проданных билетов по классам
                  WHEN tf.fare_conditions = 'Economy' THEN tf.fare_conditions
                  END) AS ticket_economy,
          count(CASE
                  WHEN tf.fare_conditions = 'Comfort' THEN tf.fare_conditions
                  END) AS ticket_comfort,
          count(CASE
                  WHEN tf.fare_conditions = 'Business' THEN tf.fare_conditions
                  END) AS ticket_bisiness,
          count(tf.fare_conditions) AS ticket_total, -- всего продано билетов
          sum(CASE -- Сумма проданных билетов по классам
                  WHEN tf.fare_conditions = 'Economy' THEN tf.amount
                  ELSE 0
                  END) AS amount_economy,
          sum(CASE
                  WHEN tf.fare_conditions = 'Comfort' THEN tf.amount
                  ELSE 0
                  END) AS amount_comfort,
          sum(CASE
                  WHEN tf.fare_conditions = 'Business' THEN tf.amount
                  ELSE 0
                  END) AS amount_bisiness,
          sum(tf.amount) amount_total
      FROM dst_project.ticket_flights AS tf
            JOIN dst_project.BOARDING_PASSES AS bp ON tf.ticket_no = bp.ticket_no
                AND tf.flight_id = bp.flight_id
      GROUP BY 1
    ),
    table_2 AS -- места в самолётах по классам
        (
          SELECT
              a.aircraft_code,
              a.model,
              a.range,
              count(CASE
                        WHEN s.fare_conditions = 'Economy' THEN s.fare_conditions
                    END) AS seat_economy,
              count(CASE
                        WHEN s.fare_conditions = 'Comfort' THEN s.fare_conditions
                    END) AS seat_comfort,
              count(CASE
                        WHEN s.fare_conditions = 'Business' THEN s.fare_conditions
                    END) AS seat_bisiness,
              count(s.fare_conditions) AS seat_total
          FROM dst_project.AIRCRAFTS AS a
                JOIN dst_project.SEATS AS s ON a.aircraft_code = s.aircraft_code
          GROUP BY 1,2,3
        ),
    table_3 AS -- время в пути (план и факт)
        (
        SELECT
            f.flight_id,
            (DATE_PART('day', f.scheduled_arrival::timestamp - f.scheduled_departure::timestamp) * 24 + 
                  DATE_PART('hour', f.scheduled_arrival::timestamp - f.scheduled_departure::timestamp)) * 60 +
                  DATE_PART('minute', f.scheduled_arrival::timestamp - f.scheduled_departure::timestamp) scheduled_duration_minute, -- запланированная длительность полета в минутах
                  
            (DATE_PART('day', f.actual_arrival::timestamp - f.actual_departure::timestamp) * 24 + 
                  DATE_PART('hour', f.actual_arrival::timestamp - f.actual_departure::timestamp)) * 60 +
                  DATE_PART('minute', f.actual_arrival::timestamp - f.actual_departure::timestamp) actual_duration_minute, -- фактическая длительность полета в минутах
                  
            (DATE_PART('day', f.actual_departure::timestamp - f.scheduled_departure::timestamp) * 24 + 
                  DATE_PART('hour', f.actual_departure::timestamp - f.scheduled_departure::timestamp)) * 60 +
                  DATE_PART('minute', f.actual_departure::timestamp - f.scheduled_departure::timestamp) departure_delay_minute, -- задержка вылета в минутах
                 
            (DATE_PART('day', f.actual_arrival::timestamp - f.scheduled_arrival::timestamp) * 24 + 
                  DATE_PART('hour', f.actual_arrival::timestamp - f.scheduled_arrival::timestamp)) * 60 +
                  DATE_PART('minute', f.actual_arrival::timestamp - f.scheduled_arrival::timestamp) delay_arrival_minute -- задержка прилёта в минутах
        FROM dst_project.flights f
        )
SELECT
    f.flight_id,
    f.flight_no,
    f.scheduled_departure,
    f.scheduled_arrival,
    f.departure_airport,
    da.airport_name departure_airport_name,
    da.city departure_city,
    da.longitude departure_longitude,
    da.latitude departure_latitude,
    da.timezone departure_timezone,
    f.arrival_airport,
    aa.airport_name arrival_airport_name,
    aa.city arrival_city,
    aa.longitude arrival_longitude,
    aa.latitude arrival_latitude,
    aa.timezone arrival_timezone,
    f.status,
    f.actual_departure,
    f.actual_arrival,
    table_1.total_classes,
    table_1.ticket_economy,
    table_1.ticket_comfort,
    table_1.ticket_bisiness,
    table_1.ticket_total,
    table_1.amount_economy,
    table_1.amount_comfort,
    table_1.amount_bisiness,
    table_1.amount_total,
    table_2.aircraft_code,
    table_2.model,
    table_2.range,
    table_2.seat_economy,
    table_2.seat_comfort,
    table_2.seat_bisiness,
    table_2.seat_total,
    table_3.scheduled_duration_minute,
    table_3.actual_duration_minute,
    table_3.departure_delay_minute,
    table_3.delay_arrival_minute
FROM dst_project.flights f
    LEFT JOIN table_1 ON f.flight_id = table_1.flight_id
    LEFT JOIN table_2 ON f.aircraft_code = table_2.aircraft_code
    LEFT JOIN table_3 ON f.flight_id = table_3.flight_id
    LEFT JOIN dst_project.airports aa ON f.arrival_airport = aa.airport_code
    LEFT JOIN dst_project.airports da ON f.departure_airport = da.airport_code
WHERE f.departure_airport = 'AAQ'
  AND (date_trunc('month', f.scheduled_departure) in ('2017-01-01',
                                                      '2017-02-01',
                                                      '2017-12-01'))
  AND f.status not in ('Cancelled')